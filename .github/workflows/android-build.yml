name: Build and upload APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/.android-sdk
      ANDROID_HOME: ${{ github.workspace }}/.android-sdk
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK components
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          mkdir -p "$ANDROID_SDK_ROOT"
          echo "Searching for sdkmanager..."
          if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$ANDROID_SDK_ROOT/tools/bin/sdkmanager" ]; then
            SDKMANAGER="$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
          else
            SDKMANAGER="$(which sdkmanager 2>/dev/null || true)"
          fi
          if [ -z "$SDKMANAGER" ]; then
            echo "sdkmanager not found. Installing command-line tools..."
            cd "$HOME"
            curl -sSLo commandlinetools.zip "https://dl.google.com/android/repository/commandlinetools-linux-13114758_latest.zip"
            unzip -q commandlinetools.zip -d "$HOME/cmdline-tools"
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$HOME/cmdline-tools/cmdline-tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
            SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          fi
          echo "Using sdkmanager at: $SDKMANAGER"
          export PATH="$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          # Accept licenses and install required components
          yes | "$SDKMANAGER" --licenses || true
          "$SDKMANAGER" "platform-tools" "platforms;android-35" "build-tools;35.0.0"

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: List APK outputs for debug
        run: |
          echo "Listing app/build/outputs/apk"
          ls -R app/build/outputs/apk || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: encryptpad-app-debug
          path: app/build/outputs/apk/**/app*-debug.apk

      # - name: Build Release APK
      #   run: ./gradlew assembleRelease --no-daemon

      # - name: Optionally sign release APK (if keystore provided)
      #   env:
      #     KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      #     KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      #     KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      #   run: |
      #     set -e
      #     APK_DIR=app/build/outputs/apk/release
      #     echo "Listing $APK_DIR"
      #     ls -la "$APK_DIR" || true
      #     APK=$(ls "$APK_DIR"/*.apk 2>/dev/null | head -n1 || true)
      #     if [ -z "$APK" ]; then
      #       echo "No release APK found in $APK_DIR"
      #       exit 1
      #     fi
      #     echo "Found APK: $APK"
      #     if [ -n "$KEYSTORE_BASE64" ]; then
      #       echo "Decoding keystore..."
      #       echo "$KEYSTORE_BASE64" | base64 --decode > release.keystore
      #       chmod 600 release.keystore
      #       BUILD_TOOLS=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -n1)
      #       ZIPALIGN="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS/zipalign"
      #       APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS/apksigner"
      #       echo "Using build-tools: $BUILD_TOOLS"
      #       ALIGNED_APK=app-release-aligned.apk
      #       SIGNED_APK=app-release-signed.apk
      #       echo "Zipaligning..."
      #       "$ZIPALIGN" -v -p 4 "$APK" "$ALIGNED_APK"
      #       echo "Signing..."
      #       "$APKSIGNER" sign --ks release.keystore --ks-pass pass:$KEYSTORE_PASSWORD --key-pass pass:$KEY_PASSWORD --out "$SIGNED_APK" "$ALIGNED_APK"
      #       echo "Signed APK: $SIGNED_APK"
      #     else
      #       echo "No keystore provided; skipping signing. Uploading unsigned release APK."
      #     fi

      # - name: Upload Release APK artifact(s)
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: encryptpad-app-release
      #     path: |
      #       app/build/outputs/apk/**/app-*-release*.apk
      #       app-release-signed.apk